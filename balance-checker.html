<!DOCTYPE html>
<html lang="zh-Hant">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ•¸å€¼æ¨¡å‹æª¢æ ¸å·¥å…·</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Microsoft YaHei', 'PingFang SC', sans-serif;
            background: linear-gradient(135deg, #1e3c72 0%, #2a5298 50%, #7e22ce 100%);
            color: #e0e0e0;
            padding: 20px;
            min-height: 100vh;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
        }

        h1 {
            text-align: center;
            margin-bottom: 30px;
            color: #ffd700;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.5);
            font-size: 2.5em;
        }

        .tool-section {
            background: rgba(0, 0, 0, 0.4);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            padding: 25px;
            margin-bottom: 25px;
            border: 1px solid rgba(255, 215, 0, 0.3);
        }

        .tool-section h2 {
            color: #ffd700;
            margin-bottom: 20px;
            font-size: 1.8em;
            border-bottom: 2px solid rgba(255, 215, 0, 0.3);
            padding-bottom: 10px;
        }

        .input-group {
            display: flex;
            gap: 15px;
            margin-bottom: 20px;
            flex-wrap: wrap;
            align-items: center;
        }

        .input-group label {
            color: #a0d8ff;
            font-weight: bold;
            min-width: 120px;
        }

        .input-group input,
        .input-group select {
            padding: 10px;
            border-radius: 8px;
            border: 2px solid rgba(255, 215, 0, 0.3);
            background: rgba(0, 0, 0, 0.5);
            color: #fff;
            font-size: 1em;
            min-width: 150px;
        }

        .input-group input:focus,
        .input-group select:focus {
            outline: none;
            border-color: #ffd700;
            box-shadow: 0 0 10px rgba(255, 215, 0, 0.5);
        }

        button {
            padding: 12px 30px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1.1em;
            font-weight: bold;
            transition: all 0.3s;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.3);
        }

        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(102, 126, 234, 0.4);
        }

        button:active {
            transform: translateY(0);
        }

        .result-container {
            margin-top: 25px;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            background: rgba(0, 0, 0, 0.3);
            border-radius: 10px;
            overflow: hidden;
        }

        th,
        td {
            padding: 15px;
            text-align: left;
            border-bottom: 1px solid rgba(255, 215, 0, 0.2);
        }

        th {
            background: rgba(255, 215, 0, 0.2);
            color: #ffd700;
            font-weight: bold;
            text-align: center;
        }

        td {
            text-align: center;
        }

        tr:hover {
            background: rgba(255, 215, 0, 0.1);
        }

        .highlight {
            color: #4caf50;
            font-weight: bold;
        }

        .warning {
            color: #ff9800;
            font-weight: bold;
        }

        .error {
            color: #f44336;
            font-weight: bold;
        }

        .summary-box {
            background: rgba(255, 215, 0, 0.1);
            border-left: 4px solid #ffd700;
            padding: 20px;
            margin-top: 20px;
            border-radius: 8px;
        }

        .summary-box h3 {
            color: #ffd700;
            margin-bottom: 15px;
        }

        .summary-item {
            display: flex;
            justify-content: space-between;
            padding: 8px 0;
            border-bottom: 1px solid rgba(255, 215, 0, 0.2);
        }

        .summary-item:last-child {
            border-bottom: none;
        }

        .summary-label {
            color: #a0d8ff;
        }

        .summary-value {
            color: #4caf50;
            font-weight: bold;
        }

        .grid-2 {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 25px;
        }

        @media (max-width: 1024px) {
            .grid-2 {
                grid-template-columns: 1fr;
            }
        }

        .back-link {
            display: inline-block;
            margin-bottom: 20px;
            color: #a0d8ff;
            text-decoration: none;
            padding: 10px 20px;
            background: rgba(0, 0, 0, 0.3);
            border-radius: 8px;
            transition: all 0.3s;
        }

        .back-link:hover {
            background: rgba(255, 215, 0, 0.2);
            color: #ffd700;
        }

        .info-text {
            color: #a0d8ff;
            font-size: 0.9em;
            margin-top: 10px;
            font-style: italic;
        }
    </style>
</head>

<body>
    <div class="container">
        <a href="start.html" class="back-link">â† è¿”å›å°èˆª</a>

        <h1>ğŸ” æ•¸å€¼æ¨¡å‹æª¢æ ¸å·¥å…·</h1>

        <!-- ç·©å­˜æ¸…é™¤æç¤º -->
        <div
            style="background: rgba(255, 152, 0, 0.2); border-left: 4px solid #ff9800; padding: 15px; margin-bottom: 20px; border-radius: 8px;">
            <strong>ğŸ’¡ æç¤ºï¼š</strong>å¦‚æœçœ‹åˆ°æ•¸æ“šç•°å¸¸æˆ–ä¸æ›´æ–°ï¼Œè«‹æŒ‰ <code>Ctrl+Shift+R</code> (Windows) æˆ– <code>Cmd+Shift+R</code> (Mac)
            å¼·åˆ¶åˆ·æ–°é é¢æ¸…é™¤ç·©å­˜ã€‚
        </div>

        <!-- æ™‚æœŸé€²åº¦æ¨¡æ“¬ -->
        <div class="tool-section">
            <h2>ğŸ“Š A. æ™‚æœŸé€²åº¦æ¨¡æ“¬ï¼ˆç¬¬1-12æ™‚æœŸï¼‰</h2>
            <p class="info-text">æ¨¡æ“¬å¾ç·´æ°£æœŸåˆ°é‡‘ä»™çš„å®Œæ•´ä¿®ç…‰æ­·ç¨‹ï¼Œè¨ˆç®—æ¯å€‹æ™‚æœŸæ‰€éœ€çš„æ™‚é–“å’Œç´¯è¨ˆæ™‚é–“</p>
            <div class="input-group">
                <button id="simulateEras">é–‹å§‹æ¨¡æ“¬</button>
            </div>
            <div id="eraResults" class="result-container"></div>
        </div>

        <!-- è³‡æºä¸Šé™è¨ˆç®— -->
        <div class="tool-section">
            <h2>ğŸ’ B. è³‡æºä¸Šé™è¨ˆç®—å™¨</h2>
            <p class="info-text">æ ¹æ“šé“å¿ƒã€é“è­‰å’Œç›®æ¨™æ™‚æœŸï¼Œè¨ˆç®—å¯é”åˆ°çš„æœ€å¤§è³‡æºä¸Šé™ï¼ˆä¸å«åˆæˆè³‡æºï¼‰</p>
            <div class="input-group">
                <label>é“å¿ƒå€¼ï¼š</label>
                <input type="number" id="daoHeart" value="0" min="0" step="1">

                <label>é“è­‰å€¼ï¼š</label>
                <input type="number" id="daoProof" value="0" min="0" step="1">

                <label>ç›®æ¨™æ™‚æœŸï¼š</label>
                <select id="targetEra">
                    <option value="1">1 - ç·´æ°£æœŸ</option>
                    <option value="2">2 - ç¯‰åŸºæœŸ</option>
                    <option value="3">3 - é‡‘ä¸¹æœŸ</option>
                    <option value="4">4 - å…ƒå¬°æœŸ</option>
                    <option value="5">5 - åŒ–ç¥æœŸ</option>
                    <option value="6">6 - ç…‰è™›æœŸ</option>
                    <option value="7">7 - åˆé«”æœŸ</option>
                    <option value="8">8 - å¤§ä¹˜æœŸ</option>
                    <option value="9">9 - æ¸¡åŠ«æœŸ</option>
                    <option value="10">10 - åœ°ä»™</option>
                    <option value="11">11 - å¤©ä»™</option>
                    <option value="12">12 - é‡‘ä»™</option>
                </select>

                <button id="calculateResources">è¨ˆç®—è³‡æºä¸Šé™</button>
            </div>
            <div id="resourceResults" class="result-container"></div>
        </div>

        <!-- å»ºè­°çš„é¡å¤–æª¢æ ¸é …ç›® -->
        <div class="tool-section">
            <h2>ğŸ¯ C. å»ºç¯‰æŠ•è³‡å›å ±åˆ†æ</h2>
            <p class="info-text">åˆ†æä¸åŒå»ºç¯‰çš„æŠ•è³‡å›å ±ç‡ï¼Œå¹«åŠ©å„ªåŒ–å»ºé€ é †åº</p>
            <div class="input-group">
                <button id="analyzeBuildingROI">åˆ†æå»ºç¯‰ ROI</button>
            </div>
            <div id="buildingResults" class="result-container"></div>
        </div>

        <div class="tool-section">
            <h2>âš¡ D. åŠŸæ³•æ•ˆç›Šåˆ†æ</h2>
            <p class="info-text">è¨ˆç®—å„åŠŸæ³•çš„æŠ€èƒ½é»æŠ•è³‡æ•ˆç›Šï¼Œå„ªåŒ–å­¸ç¿’é †åº</p>
            <div class="input-group">
                <button id="analyzeSkills">åˆ†æåŠŸæ³•æ•ˆç›Š</button>
            </div>
            <div id="skillResults" class="result-container"></div>
        </div>

        <div class="tool-section">
            <h2>â±ï¸ E. åŠŸæ³•å­¸ç¿’æ™‚é–“è¨ˆç®—</h2>
            <p class="info-text">è¨ˆç®—åœ¨çµ¦å®šè—æ›¸é–£ç­‰ç´šä¸‹ï¼Œç²å¾—è¶³å¤ æŠ€èƒ½é»å­¸ç¿’å„åŠŸæ³•éœ€è¦çš„æ™‚é–“</p>
            <div class="input-group">
                <label>è—æ›¸é–£ç­‰ç´šï¼š</label>
                <input type="number" id="libraryLevel" value="10" min="0" max="100">
                <label>è—ç¶“é–£ç­‰ç´šï¼š</label>
                <input type="number" id="scriptureLevel" value="0" min="0" max="100">
            </div>
            <div class="input-group">
                <button id="calculateSkillTime">è¨ˆç®—å­¸ç¿’æ™‚é–“</button>
            </div>
            <div id="skillTimeResults" class="result-container"></div>
        </div>
    </div>

    <script type="module">
        // å°å…¥å¿…è¦çš„æ¨¡çµ„
        let EraManager, ResourceManager, BuildingManager, SkillManager;
        let Buildings;

        async function init() {
            try {
                const eraModule = await import('./src/utils/EraManager.js');
                EraManager = eraModule.default;
                await EraManager.init();

                const resModule = await import('./src/data/Resources.js');
                ResourceManager = resModule.default;

                const buildingModule = await import('./src/data/Buildings.js');
                await buildingModule.loadBuildings();
                Buildings = buildingModule.Buildings;

                const skillModule = await import('./src/utils/SkillManager.js');
                SkillManager = skillModule.default;
                await SkillManager.init();

                console.log('âœ“ æ‰€æœ‰æ¨¡çµ„è¼‰å…¥å®Œæˆ');
            } catch (e) {
                console.error('æ¨¡çµ„è¼‰å…¥å¤±æ•—:', e);
                alert('æ¨¡çµ„è¼‰å…¥å¤±æ•—ï¼Œè«‹ç¢ºèªä¼ºæœå™¨æ­£åœ¨é‹è¡Œ');
            }
        }

        // A. æ™‚æœŸé€²åº¦æ¨¡æ“¬
        document.getElementById('simulateEras').addEventListener('click', () => {
            if (!EraManager) {
                alert('æ™‚æœŸæ•¸æ“šå°šæœªè¼‰å…¥');
                return;
            }

            const eras = EraManager.getAllEras();
            console.log('è¼‰å…¥çš„æ™‚æœŸæ•¸æ“š:', eras); // èª¿è©¦ç”¨

            let html = '<table>';
            html += '<tr><th>æ™‚æœŸ</th><th>åç¨±</th><th>æœ€å¤§ç­‰ç´š</th><th>è©²æ™‚æœŸå£½å…ƒ(å¹´)</th><th>ç´¯è¨ˆå£½å…ƒ(å¹´)</th><th>è©²æ™‚æœŸçœŸå¯¦æ™‚é–“</th><th>ç´¯è¨ˆçœŸå¯¦æ™‚é–“</th><th>ç­‰ç´šå‡ç´šæ™‚é–“</th></tr>';

            let totalYears = 0;
            let totalMinutes = 0;
            const daoHeart = parseInt(document.getElementById('daoHeart').value) || 0;
            const daoProof = parseInt(document.getElementById('daoProof').value) || 0;
            const speedBonus = daoHeart * 0.001 + daoProof * 0.01;

            eras.forEach(era => {
                const eraLifespanMax = calculateLifespanUpTo(era.eraId, eras);
                const previousLifespanMax = era.eraId > 1 ? calculateLifespanUpTo(era.eraId - 1, eras) : 0;
                const thisEraYears = eraLifespanMax - previousLifespanMax;

                totalYears = eraLifespanMax;
                totalMinutes = totalYears; // 1å¹´ = 1åˆ†é˜

                // è¨ˆç®—ç­‰ç´šå‡ç´šæ™‚é–“
                const baseTime = era.levelUpRequirements?.baseTime || 60;
                const timeMult = era.levelUpRequirements?.timeMultiplier || 1.2;
                let levelUpTime = 0; // ç§’
                for (let lv = 1; lv <= era.maxLevel; lv++) {
                    levelUpTime += baseTime * Math.pow(timeMult, lv - 1);
                }

                // æ‡‰ç”¨é€Ÿåº¦åŠ æˆ
                levelUpTime /= (1 + speedBonus);

                // è¨ˆç®—ä½”æ¯”
                const timeInMinutes = levelUpTime / 60;
                const ratio = (timeInMinutes / thisEraYears * 100).toFixed(1);
                let ratioClass = 'highlight';
                if (parseFloat(ratio) > 100) ratioClass = 'error';
                else if (parseFloat(ratio) > 80) ratioClass = 'warning';

                html += `<tr>
                    <td>${era.eraId}</td>
                    <td><strong>${era.eraName}</strong></td>
                    <td>${era.maxLevel}</td>
                    <td class="highlight">${thisEraYears.toFixed(0)}</td>
                    <td>${totalYears.toFixed(0)}</td>
                    <td class="highlight">${formatTime(thisEraYears)}</td>
                    <td>${formatTime(totalMinutes)}</td>
                    <td class="${ratioClass}">${formatTime(timeInMinutes)} (${ratio}%)</td>
                </tr>`;
            });

            html += '</table>';

            // æ·»åŠ ç¸½çµ
            html += `<div class="summary-box">
                <h3>ğŸ“ˆ ç¸½é«”çµ±è¨ˆ</h3>
                <div class="summary-item">
                    <span class="summary-label">ä¿®ç…‰è‡³é‡‘ä»™æ‰€éœ€ç¸½å£½å…ƒï¼š</span>
                    <span class="summary-value">${totalYears.toFixed(0)} å¹´</span>
                </div>
                <div class="summary-item">
                    <span class="summary-label">çœŸå¯¦ä¸–ç•Œæ‰€éœ€æ™‚é–“ï¼š</span>
                    <span class="summary-value">${formatTime(totalMinutes)}</span>
                </div>
                <div class="summary-item">
                    <span class="summary-label">ç•¶å‰æ¨¡æ“¬åŠ æˆ (é“å¿ƒ+é“è­‰)ï¼š</span>
                    <span class="summary-value">+${(speedBonus * 100).toFixed(1)}% ä¿®ç…‰é€Ÿåº¦</span>
                </div>
                <div class="summary-item">
                    <span class="summary-label">å¹³å‡æ¯æ™‚æœŸå£½å…ƒï¼š</span>
                    <span class="summary-value">${(totalYears / 12).toFixed(0)} å¹´</span>
                </div>
            </div>`;

            document.getElementById('eraResults').innerHTML = html;
        });

        // è¨ˆç®—åˆ°æŸæ™‚æœŸçš„ç´¯è¨ˆå£½å…ƒ
        function calculateLifespanUpTo(eraId, eras) {
            if (!eras) eras = EraManager.getAllEras();
            let total = 0;
            for (let i = 1; i <= eraId; i++) {
                const era = eras.find(e => e.eraId === i);
                if (era && era.lifespan) {
                    total += era.lifespan;
                } else {
                    total += (i === 1 ? 80 : i * 100);
                }
            }
            return total;
        }

        // æ ¼å¼åŒ–æ™‚é–“
        function formatTime(minutes) {
            if (minutes < 60) {
                return `${minutes.toFixed(1)} åˆ†é˜`;
            } else if (minutes < 1440) {
                const hours = minutes / 60;
                return `${hours.toFixed(1)} å°æ™‚`;
            } else {
                const days = minutes / 1440;
                return `${days.toFixed(1)} å¤©`;
            }
        }

        // B. è³‡æºä¸Šé™è¨ˆç®—
        document.getElementById('calculateResources').addEventListener('click', async () => {
            const daoHeart = parseInt(document.getElementById('daoHeart').value) || 0;
            const daoProof = parseInt(document.getElementById('daoProof').value) || 0;
            const targetEra = parseInt(document.getElementById('targetEra').value);

            if (!EraManager || !Buildings || !SkillManager) {
                alert('æ•¸æ“šå°šæœªè¼‰å…¥');
                return;
            }

            // è¨ˆç®—åŠ æˆ
            const daoHeartBonus = daoHeart * 0.001; // 0.1% per point
            const daoProofBonus = daoProof * 0.01;  // 1% per point

            // è¼‰å…¥è³‡æºæ•¸æ“š
            const resourceManager = new ResourceManager();
            await resourceManager.init();

            const baseResources = resourceManager.getBaseData();
            const era = EraManager.getEraById(targetEra);

            // èª¿è©¦è¼¸å‡º
            console.log('=== è³‡æºä¸Šé™è¨ˆç®—å™¨èª¿è©¦ ===');
            console.log('ç›®æ¨™æ™‚æœŸ:', targetEra, era?.eraName);

            // è¨ˆç®—è©²æ™‚æœŸå¯é”åˆ°çš„æœ€å¤§è³‡æºä¸Šé™
            const maxCapacity = {};
            const basicResources = ['lingli', 'money', 'wood', 'stone', 'herb', 'skill_point'];

            // 1. åˆå§‹åŒ–åŸºç¤ä¸Šé™
            basicResources.forEach(key => {
                const res = baseResources[key];
                if (res && res.type === 'basic') {
                    maxCapacity[key] = {
                        name: res.name,
                        base: res.max,
                        fromBuildings: 0,
                        fromSkills: 0,
                        beforeBonus: 0,
                        final: 0
                    };
                }
            });

            // 2. è¨ˆç®—å»ºç¯‰æä¾›çš„ä¸Šé™åŠ æˆ
            Object.entries(Buildings).forEach(([id, building]) => {
                if (building.era <= targetEra && building.effects) {
                    const maxLevel = building.maxLevel;
                    Object.entries(building.effects).forEach(([effectKey, effectValue]) => {
                        if (effectKey.endsWith('_max')) {
                            const resourceKey = effectKey.replace('_max', '');
                            if (maxCapacity[resourceKey]) {
                                const totalBonus = effectValue * maxLevel;
                                maxCapacity[resourceKey].fromBuildings += totalBonus;
                            }
                        }
                    });
                }
            });

            // 3. è¨ˆç®—åŠŸæ³•æä¾›çš„ä¸Šé™åŠ æˆ
            const allSkills = SkillManager.getSkills();
            Object.entries(allSkills).forEach(([id, skill]) => {
                if (skill.requirements.era <= targetEra && skill.effects) {
                    const effectType = skill.effects.type;
                    const effectAmount = skill.effects.amount;

                    if (effectType === 'all_max') {
                        basicResources.forEach(key => {
                            if (maxCapacity[key]) {
                                maxCapacity[key].fromSkills += effectAmount;
                            }
                        });
                    } else if (effectType.endsWith('_max')) {
                        const resourceKey = effectType.replace('_max', '');
                        if (maxCapacity[resourceKey]) {
                            maxCapacity[resourceKey].fromSkills += effectAmount;
                        }
                    }
                }
            });

            // 4. æ‡‰ç”¨é“å¿ƒé“è­‰åŠ æˆ
            basicResources.forEach(key => {
                if (maxCapacity[key]) {
                    const beforeBonus = maxCapacity[key].base +
                        maxCapacity[key].fromBuildings +
                        maxCapacity[key].fromSkills;
                    maxCapacity[key].beforeBonus = beforeBonus;
                    const withDaoHeart = beforeBonus * (1 + daoHeartBonus);
                    const final = withDaoHeart * (1 + daoProofBonus);
                    maxCapacity[key].final = Math.floor(final);
                }
            });

            // 5. ç²å–æ™‚æœŸè¦æ±‚
            let eraCapacityRequirements = {};
            if (era && era.upgradeRequirements && era.upgradeRequirements.capacity) {
                eraCapacityRequirements = era.upgradeRequirements.capacity;
            }

            // 6. ç”Ÿæˆè¡¨æ ¼
            let html = '<table>';
            html += '<tr><th>è³‡æºåç¨±</th><th>åŸºç¤ä¸Šé™</th><th>å»ºç¯‰åŠ æˆ</th><th>åŠŸæ³•åŠ æˆ</th><th>å°è¨ˆ</th><th>é“å¿ƒé“è­‰</th><th>æœ€çµ‚ä¸Šé™</th><th>æ™‚æœŸè¦æ±‚</th><th>é”æ¨™</th></tr>';

            basicResources.forEach(key => {
                const cap = maxCapacity[key];
                if (cap) {
                    const eraRequirement = eraCapacityRequirements[key] || 0;
                    let meetsRequirement = '';
                    let requirementClass = '';
                    if (eraRequirement > 0) {
                        if (cap.final >= eraRequirement) {
                            meetsRequirement = 'âœ“';
                            requirementClass = 'highlight';
                        } else {
                            meetsRequirement = 'âœ—';
                            requirementClass = 'error';
                        }
                    } else {
                        meetsRequirement = '-';
                    }

                    const bonusPercent = (((1 + daoHeartBonus) * (1 + daoProofBonus) - 1) * 100).toFixed(1);

                    html += `<tr>
                        <td><strong>${cap.name}</strong></td>
                        <td>${formatNumber(cap.base)}</td>
                        <td class="${cap.fromBuildings > 0 ? 'highlight' : ''}">${cap.fromBuildings > 0 ? '+' + formatNumber(cap.fromBuildings) : '-'}</td>
                        <td class="${cap.fromSkills > 0 ? 'highlight' : ''}">${cap.fromSkills > 0 ? '+' + formatNumber(cap.fromSkills) : '-'}</td>
                        <td>${formatNumber(cap.beforeBonus)}</td>
                        <td>+${bonusPercent}%</td>
                        <td class="highlight"><strong>${formatNumber(cap.final)}</strong></td>
                        <td>${eraRequirement > 0 ? formatNumber(eraRequirement) : '-'}</td>
                        <td class="${requirementClass}">${meetsRequirement}</td>
                    </tr>`;
                }
            });

            html += '</table>';

            // è¨ˆç®—æ»¿è¶³æ™‚æœŸè¦æ±‚æ‰€éœ€çš„æœ€å°é“å¿ƒ/é“è­‰
            let requiredDaoHeart = 0;
            let requiredDaoProof = 0;
            let hasRequirements = false;

            // æ‰¾å‡ºæœ€åš´æ ¼çš„è³‡æºè¦æ±‚
            let maxRequiredRatio = 0;
            basicResources.forEach(key => {
                const cap = maxCapacity[key];
                const requirement = eraCapacityRequirements[key] || 0;
                if (requirement > 0 && cap) {
                    hasRequirements = true;
                    // è¨ˆç®—éœ€è¦çš„å€ç‡ï¼šè¦æ±‚å€¼ / å°è¨ˆå€¼
                    const requiredRatio = requirement / cap.beforeBonus;
                    if (requiredRatio > maxRequiredRatio) {
                        maxRequiredRatio = requiredRatio;
                    }
                }
            });

            // è¨ˆç®—æ‰€éœ€çš„é“å¿ƒ/é“è­‰çµ„åˆ
            if (hasRequirements && maxRequiredRatio > 1) {
                // éœ€è¦çš„ç¸½åŠ æˆå€ç‡
                const neededMultiplier = maxRequiredRatio;

                // å‡è¨­åªç”¨é“è­‰ï¼ˆ1% per pointï¼‰
                requiredDaoProof = Math.ceil((neededMultiplier - 1) * 100);

                // å‡è¨­åªç”¨é“å¿ƒï¼ˆ0.1% per pointï¼‰
                requiredDaoHeart = Math.ceil((neededMultiplier - 1) * 1000);
            }

            // æ·»åŠ ç¸½çµ
            html += `<div class="summary-box">
                <h3>ğŸ’¡ åˆ†æçµæœ</h3>
                <div class="summary-item">
                    <span class="summary-label">ç›®æ¨™æ™‚æœŸï¼š</span>
                    <span class="summary-value">${era ? era.eraName : 'æœªçŸ¥'} (ç¬¬${targetEra}æ™‚æœŸ)</span>
                </div>
                <div class="summary-item">
                    <span class="summary-label">è¨ˆç®—æ–¹å¼ï¼š</span>
                    <span class="summary-value">åŸºç¤ä¸Šé™ + æ‰€æœ‰å¯ç”¨å»ºç¯‰(æ»¿ç´š) + æ‰€æœ‰å¯ç”¨åŠŸæ³•</span>
                </div>
                <div class="summary-item">
                    <span class="summary-label">ç•¶å‰é“å¿ƒï¼š</span>
                    <span class="summary-value">${daoHeart} (åŠ æˆ +${(daoHeartBonus * 100).toFixed(1)}%)</span>
                </div>
                <div class="summary-item">
                    <span class="summary-label">ç•¶å‰é“è­‰ï¼š</span>
                    <span class="summary-value">${daoProof} (åŠ æˆ +${(daoProofBonus * 100).toFixed(1)}%)</span>
                </div>
                <div class="summary-item">
                    <span class="summary-label">ç¶œåˆåŠ æˆï¼š</span>
                    <span class="summary-value">+${(((1 + daoHeartBonus) * (1 + daoProofBonus) - 1) * 100).toFixed(1)}%</span>
                </div>
            </div>`;

            // æ·»åŠ å‡éšå»ºè­°
            if (hasRequirements) {
                const allMet = basicResources.every(key => {
                    const cap = maxCapacity[key];
                    const requirement = eraCapacityRequirements[key] || 0;
                    return requirement === 0 || cap.final >= requirement;
                });

                html += `<div class="summary-box" style="background: ${allMet ? 'rgba(76, 175, 80, 0.1)' : 'rgba(255, 152, 0, 0.1)'}; border-left-color: ${allMet ? '#4caf50' : '#ff9800'};">
                    <h3>${allMet ? 'âœ…' : 'âš ï¸'} å‡éšæ¢ä»¶åˆ†æ</h3>`;

                if (allMet) {
                    html += `<p style="color: #4caf50; margin: 10px 0;">
                        ç•¶å‰é…ç½®å·²æ»¿è¶³æ‰€æœ‰å‡éšæ¢ä»¶ï¼å¯ä»¥é †åˆ©çªç ´è‡³ä¸‹ä¸€æ™‚æœŸã€‚
                    </p>`;
                } else {
                    html += `<p style="color: #ff9800; margin: 10px 0;">
                        ç•¶å‰é…ç½®å°šæœªæ»¿è¶³å‡éšæ¢ä»¶ã€‚ä»¥ä¸‹æ˜¯å»ºè­°çš„é“å¿ƒ/é“è­‰éœ€æ±‚ï¼š
                    </p>
                    <div class="summary-item">
                        <span class="summary-label">æ–¹æ¡ˆAï¼ˆåƒ…ç”¨é“å¿ƒï¼‰ï¼š</span>
                        <span class="summary-value" style="color: #a0d8ff;">è‡³å°‘éœ€è¦ ${requiredDaoHeart} é“å¿ƒ</span>
                    </div>
                    <div class="summary-item">
                        <span class="summary-label">æ–¹æ¡ˆBï¼ˆåƒ…ç”¨é“è­‰ï¼‰ï¼š</span>
                        <span class="summary-value" style="color: #a0d8ff;">è‡³å°‘éœ€è¦ ${requiredDaoProof} é“è­‰</span>
                    </div>
                    <div class="summary-item">
                        <span class="summary-label">æ–¹æ¡ˆCï¼ˆæ··åˆä½¿ç”¨ï¼‰ï¼š</span>
                        <span class="summary-value" style="color: #a0d8ff;">ä¾‹å¦‚ ${Math.ceil(requiredDaoHeart / 2)} é“å¿ƒ + ${Math.ceil(requiredDaoProof / 2)} é“è­‰</span>
                    </div>
                    <p style="color: #a0d8ff; margin: 10px 0; font-size: 0.9em; font-style: italic;">
                        ğŸ’¡ æç¤ºï¼šé“è­‰æ•ˆç‡æ›´é«˜ï¼ˆ1%/é» vs 0.1%/é»ï¼‰ï¼Œå»ºè­°å„ªå…ˆæå‡é“è­‰ã€‚
                    </p>`;
                }

                html += `</div>`;
            }

            document.getElementById('resourceResults').innerHTML = html;
        });

        // C. å»ºç¯‰æŠ•è³‡å›å ±åˆ†æ
        document.getElementById('analyzeBuildingROI').addEventListener('click', () => {
            if (!Buildings) {
                alert('å»ºç¯‰æ•¸æ“šå°šæœªè¼‰å…¥');
                return;
            }

            console.log('Building ROI Analysis - Total buildings:', Object.keys(Buildings).length);

            let html = '<table>';
            html += '<tr><th>å»ºç¯‰åç¨±</th><th>åˆå§‹æˆæœ¬</th><th>ç”¢å‡ºé¡å‹</th><th>åŸºç¤ç”¢ç‡</th><th>æ¬Šé‡</th><th>Lv.1 ç”¢ç‡</th><th>ROI è©•ç´š</th></tr>';

            const buildingData = [];

            Object.entries(Buildings).forEach(([id, building]) => {
                // Check if effects exists and has at least one key
                const effectKeys = building.effects ? Object.keys(building.effects) : [];
                if (effectKeys.length > 0) {
                    const totalCost = Object.values(building.baseCost || {}).reduce((sum, val) => sum + val, 0);
                    const effectKey = effectKeys[0];
                    const effectValue = building.effects[effectKey];
                    const weight = building.effectWeight || 0;

                    // Skip if effectValue is 0 or negative (special buildings like rebirth_lotus)
                    if (effectValue > 0 && totalCost > 0) {
                        const level1Output = effectValue * Math.pow(1 + weight, 2);

                        // è¨ˆç®— ROIï¼ˆç°¡åŒ–ç‰ˆï¼šç”¢å‡º/æˆæœ¬ï¼‰
                        const roi = level1Output / (totalCost / 100);

                        buildingData.push({
                            name: building.name,
                            cost: totalCost,
                            effectType: effectKey,
                            baseRate: effectValue,
                            weight: weight,
                            level1Rate: level1Output,
                            roi: roi
                        });
                    }
                }
            });

            console.log('Buildings with valid effects for ROI:', buildingData.length);

            // æŒ‰ ROI æ’åº
            buildingData.sort((a, b) => b.roi - a.roi);

            // Check if any buildings have valid ROI data
            if (buildingData.length === 0) {
                html += '<tr><td colspan="7" style="text-align: center; color: #ff9800;">ç„¡å¯è¨ˆç®— ROI çš„å»ºç¯‰ï¼ˆå»ºç¯‰éœ€æœ‰æ­£å‘ç”¢å‡ºæ•ˆæœä¸”ç„¡é›¶æˆæœ¬ï¼‰</td></tr>';
                console.warn('No buildings with valid positive effects found. Check Buildings data:', Buildings);
            }

            buildingData.forEach(b => {
                let roiClass = 'highlight';
                let roiText = 'å„ªç§€';
                if (b.roi < 0.5) {
                    roiClass = 'error';
                    roiText = 'è¼ƒä½';
                } else if (b.roi < 1) {
                    roiClass = 'warning';
                    roiText = 'ä¸­ç­‰';
                }

                html += `<tr>
                    <td><strong>${b.name}</strong></td>
                    <td>${formatNumber(b.cost)}</td>
                    <td>${b.effectType}</td>
                    <td>${b.baseRate.toFixed(3)}</td>
                    <td>${b.weight.toFixed(1)}</td>
                    <td class="highlight">${b.level1Rate.toFixed(3)}/ç§’</td>
                    <td class="${roiClass}">${roiText} (${b.roi.toFixed(2)})</td>
                </tr>`;
            });

            html += '</table>';

            html += `<div class="summary-box">
                <h3>ğŸ“Š å»ºè­°</h3>
                <p style="color: #a0d8ff; line-height: 1.8;">
                    â€¢ ROI è©•ç´šåŸºæ–¼ã€ŒLv.1 ç”¢å‡ºç‡ / åˆå§‹æˆæœ¬ã€è¨ˆç®—<br>
                    â€¢ å„ªå…ˆå»ºé€  ROI è©•ç´šç‚ºã€Œå„ªç§€ã€çš„å»ºç¯‰å¯å¿«é€Ÿæå‡è³‡æºç”¢å‡º<br>
                    â€¢ æ¬Šé‡è¼ƒé«˜çš„å»ºç¯‰åœ¨å¾ŒæœŸå‡ç´šæ™‚æ”¶ç›Šæ›´å¤§<br>
                    â€¢ å»ºè­°å¹³è¡¡ç”¢å‡ºé¡å»ºç¯‰èˆ‡ä¸Šé™é¡å»ºç¯‰çš„æŠ•è³‡
                </p>
            </div>`;

            document.getElementById('buildingResults').innerHTML = html;
        });

        // D. åŠŸæ³•æ•ˆç›Šåˆ†æ
        document.getElementById('analyzeSkills').addEventListener('click', () => {
            if (!SkillManager) {
                alert('åŠŸæ³•æ•¸æ“šå°šæœªè¼‰å…¥');
                return;
            }

            const skills = SkillManager.getSkills();

            let html = '<table>';
            html += '<tr><th>åŠŸæ³•åç¨±</th><th>æ¶ˆè€—æŠ€èƒ½é»</th><th>æ•ˆæœé¡å‹</th><th>æ•ˆæœæ•¸å€¼</th><th>æ€§åƒ¹æ¯”</th><th>æ¨è–¦åº¦</th></tr>';

            const skillData = [];

            Object.entries(skills).forEach(([id, skill]) => {
                if (skill.cost && skill.effects) {
                    const cost = skill.cost.amount;
                    const effectType = skill.effects.type;
                    const effectAmount = skill.effects.amount;

                    // è¨ˆç®—æ€§åƒ¹æ¯”ï¼ˆæ•ˆæœ/æˆæœ¬ï¼‰
                    let valuePerCost = 0;
                    if (effectType.includes('max')) {
                        valuePerCost = effectAmount / cost;
                    } else if (effectType.includes('multiplier')) {
                        valuePerCost = (effectAmount - 1) * 100 / cost;
                    } else if (effectType.includes('rate')) {
                        valuePerCost = effectAmount / cost;
                    }

                    skillData.push({
                        name: skill.name,
                        cost: cost,
                        effectType: effectType,
                        effectAmount: effectAmount,
                        valuePerCost: valuePerCost
                    });
                }
            });

            // æŒ‰æ€§åƒ¹æ¯”æ’åº
            skillData.sort((a, b) => b.valuePerCost - a.valuePerCost);

            skillData.forEach(s => {
                let recommendClass = 'highlight';
                let recommendText = 'å¼·çƒˆæ¨è–¦';
                if (s.valuePerCost < 5) {
                    recommendClass = 'error';
                    recommendText = 'è¬¹æ…è€ƒæ…®';
                } else if (s.valuePerCost < 20) {
                    recommendClass = 'warning';
                    recommendText = 'é©åº¦æ¨è–¦';
                }

                html += `<tr>
                    <td><strong>${s.name}</strong></td>
                    <td>${s.cost}</td>
                    <td>${s.effectType}</td>
                    <td>${formatNumber(s.effectAmount)}</td>
                    <td class="highlight">${s.valuePerCost.toFixed(2)}</td>
                    <td class="${recommendClass}">${recommendText}</td>
                </tr>`;
            });

            html += '</table>';

            html += `<div class="summary-box">
                <h3>ğŸ’¡ å­¸ç¿’å»ºè­°</h3>
                <p style="color: #a0d8ff; line-height: 1.8;">
                    â€¢ æ€§åƒ¹æ¯” = æ•ˆæœæ•¸å€¼ / æŠ€èƒ½é»æ¶ˆè€—<br>
                    â€¢ å„ªå…ˆå­¸ç¿’æ€§åƒ¹æ¯”é«˜çš„åŠŸæ³•å¯æœ€å¤§åŒ–æŠ€èƒ½é»æ•ˆç›Š<br>
                    â€¢ ä¸Šé™é¡åŠŸæ³•ï¼ˆmaxï¼‰åœ¨è³‡æºç·Šå¼µæ™‚å„ªå…ˆç´šè¼ƒé«˜<br>
                    â€¢ å€ç‡é¡åŠŸæ³•ï¼ˆmultiplierï¼‰åœ¨å¾ŒæœŸæ”¶ç›Šæ›´é¡¯è‘—<br>
                    â€¢ å»ºè­°æ ¹æ“šç•¶å‰ç“¶é ¸é¸æ“‡å°æ‡‰çš„åŠŸæ³•é¡å‹
                </p>
            </div>`;

            document.getElementById('skillResults').innerHTML = html;
        });

        // E. åŠŸæ³•å­¸ç¿’æ™‚é–“è¨ˆç®—
        document.getElementById('calculateSkillTime').addEventListener('click', () => {
            if (!SkillManager || !Buildings) {
                alert('æ•¸æ“šå°šæœªè¼‰å…¥');
                return;
            }

            const libraryLevel = parseInt(document.getElementById('libraryLevel').value) || 0;
            const scriptureLevel = parseInt(document.getElementById('scriptureLevel').value) || 0;

            // è¨ˆç®—æŠ€èƒ½é»ç”¢å‡ºé€Ÿç‡
            // è—æ›¸é–£ï¼šæ”¹ç‚ºç·šæ€§å¢é•· 3 é»/ç§’/ç´š
            const libraryDef = Buildings['library'];
            const scriptureDef = Buildings['scripture_hall'];

            let skillPointRate = 0;

            if (libraryLevel > 0 && libraryDef) {
                // ç·šæ€§å¢é•·ï¼š3 é»/ç§’/ç´šï¼ˆä¸å†ä½¿ç”¨äºŒæ¬¡æ–¹ï¼‰
                const amountPerLevel = libraryDef.effects['skill_point'] || 3;
                skillPointRate += amountPerLevel * libraryLevel;
            }

            // è—ç¶“é–£æä¾›æŠ€èƒ½é»ä¸Šé™ï¼Œä¸æä¾›ç”¢å‡º
            const baseMax = 1200; // åŸºç¤ä¸Šé™ 1200
            const scriptureCap = scriptureDef?.effects?.['skill_point'] || 600; // è—ç¶“é–£æ¯ç´š +600
            const maxSkillPoints = baseMax + (scriptureLevel * scriptureCap);

            const skills = SkillManager.getSkills();
            const skillData = [];

            Object.entries(skills).forEach(([id, skill]) => {
                if (skill.cost && skill.cost.type === 'skill_point') {
                    const requiredPoints = skill.cost.amount;

                    // è¨ˆç®—ç²å¾—æ‰€éœ€æŠ€èƒ½é»éœ€è¦çš„æ™‚é–“
                    let timeInSeconds = 0;
                    if (skillPointRate > 0) {
                        timeInSeconds = requiredPoints / skillPointRate;
                    } else {
                        timeInSeconds = Infinity;
                    }

                    // è½‰æ›ç‚ºæ˜“è®€æ ¼å¼
                    let timeText = '';
                    if (timeInSeconds === Infinity) {
                        timeText = 'ç„¡æ³•ç²å¾—ï¼ˆç„¡ç”¢å‡ºï¼‰';
                    } else if (timeInSeconds < 60) {
                        timeText = `${timeInSeconds.toFixed(1)} ç§’`;
                    } else if (timeInSeconds < 3600) {
                        timeText = `${(timeInSeconds / 60).toFixed(1)} åˆ†é˜`;
                    } else if (timeInSeconds < 86400) {
                        timeText = `${(timeInSeconds / 3600).toFixed(1)} å°æ™‚`;
                    } else {
                        timeText = `${(timeInSeconds / 86400).toFixed(1)} å¤©`;
                    }

                    skillData.push({
                        id: id,
                        name: skill.name,
                        cost: requiredPoints,
                        era: skill.requirements?.era || 1,
                        timeInSeconds: timeInSeconds,
                        timeText: timeText,
                        canAfford: requiredPoints <= maxSkillPoints
                    });
                }
            });

            // æŒ‰æ™‚é–“æ’åº
            skillData.sort((a, b) => a.timeInSeconds - b.timeInSeconds);

            let html = '<table>';
            html += '<tr><th>åŠŸæ³•åç¨±</th><th>æ™‚æœŸ</th><th>æŠ€èƒ½é»æ¶ˆè€—</th><th>ç²å¾—æ™‚é–“</th><th>ä¸Šé™æª¢æŸ¥</th></tr>';

            skillData.forEach(s => {
                const canAffordClass = s.canAfford ? '' : 'error';
                const canAffordText = s.canAfford ? 'âœ“' : `âœ— éœ€è¦ä¸Šé™ ${s.cost}`;

                html += `<tr>
                    <td><strong>${s.name}</strong></td>
                    <td>${s.era}</td>
                    <td>${s.cost}</td>
                    <td class="highlight">${s.timeText}</td>
                    <td class="${canAffordClass}">${canAffordText}</td>
                </tr>`;
            });

            html += '</table>';

            // æ·»åŠ ç¸½çµ
            const skillPointsPerHour = skillPointRate * 3600;
            const skillPointsPerDay = skillPointRate * 86400;

            html += `<div class="summary-box">
                <h3>ğŸ’¡ æŠ€èƒ½é»ç”¢å‡ºåˆ†æ</h3>
                <div class="summary-item">
                    <span class="summary-label">è—æ›¸é–£ç­‰ç´šï¼š</span>
                    <span class="summary-value">Lv. ${libraryLevel}</span>
                </div>
                <div class="summary-item">
                    <span class="summary-label">è—ç¶“é–£ç­‰ç´šï¼š</span>
                    <span class="summary-value">Lv. ${scriptureLevel}</span>
                </div>
                <div class="summary-item">
                    <span class="summary-label">æŠ€èƒ½é»ç”¢å‡ºé€Ÿç‡ï¼š</span>
                    <span class="summary-value">${skillPointRate.toFixed(4)} é»/ç§’</span>
                </div>
                <div class="summary-item">
                    <span class="summary-label">æ¯å°æ™‚ç”¢å‡ºï¼š</span>
                    <span class="summary-value">${skillPointsPerHour.toFixed(2)} é»</span>
                </div>
                <div class="summary-item">
                    <span class="summary-label">æ¯å¤©ç”¢å‡ºï¼š</span>
                    <span class="summary-value">${skillPointsPerDay.toFixed(2)} é»</span>
                </div>
                <div class="summary-item">
                    <span class="summary-label">æŠ€èƒ½é»ä¸Šé™ï¼š</span>
                    <span class="summary-value">${maxSkillPoints} é»</span>
                </div>
            </div>`;

            html += `<div class="summary-box" style="background: rgba(255, 152, 0, 0.1); border-left-color: #ff9800;">
                <h3>âš ï¸ ä½¿ç”¨èªªæ˜</h3>
                <p style="color: #a0d8ff; line-height: 1.8;">
                    â€¢ ç²å¾—æ™‚é–“ = æŠ€èƒ½é»æ¶ˆè€— / ç”¢å‡ºé€Ÿç‡<br>
                    â€¢ è—æ›¸é–£æä¾›æŠ€èƒ½é»ç”¢å‡ºï¼ˆäºŒæ¬¡æ–¹å¢é•·ï¼‰<br>
                    â€¢ è—ç¶“é–£æä¾›æŠ€èƒ½é»ä¸Šé™ï¼ˆæ¯ç´š +10ï¼‰<br>
                    â€¢ ä¸Šé™ä¸è¶³æ™‚ç„¡æ³•å„²å­˜è¶³å¤ çš„æŠ€èƒ½é»<br>
                    â€¢ å»ºè­°å„ªå…ˆå‡ç´šè—æ›¸é–£æå‡ç”¢å‡ºé€Ÿç‡<br>
                    â€¢ ç•¶éœ€è¦å­¸ç¿’é«˜æˆæœ¬åŠŸæ³•æ™‚å†å‡ç´šè—ç¶“é–£
                </p>
            </div>`;

            document.getElementById('skillTimeResults').innerHTML = html;
        });

        // æ ¼å¼åŒ–æ•¸å­—
        function formatNumber(num) {
            if (num >= 1000000000) {
                return (num / 1000000000).toFixed(2) + 'B';
            } else if (num >= 1000000) {
                return (num / 1000000).toFixed(2) + 'M';
            } else if (num >= 10000) {
                return (num / 1000).toFixed(1) + 'K';
            }
            return num.toFixed(0);
        }

        // åˆå§‹åŒ–
        init();
    </script>
</body>

</html>