# 資源容量要求修復驗證指南

## 🐛 問題描述

**症狀**：練氣期和金丹期的資源要求顯示相同內容（都為空或都相同）

**預期行為**：
- 練氣期：靈力要求 500
- 金丹期：靈力要求 10,000，靈石要求 5,000

---

## 🔍 根本原因分析

### 數據流程

1. **CSV 原始數據**
   ```csv
   練氣期: up_capacity = "lingli_max:500"
   金丹期: up_capacity = "lingli_max:10000,stone_max:5000"
   ```

2. **CSVLoader.parseCapacity() 解析（修復前）**
   ```javascript
   // 練氣期
   {
     lingli_max: 500  // ← 保留了 _max 後綴
   }
   
   // 金丹期
   {
     lingli_max: 10000,
     stone_max: 5000
   }
   ```

3. **balance-checker.html 查找（修復前）**
   ```javascript
   const eraRequirement = eraCapacityRequirements['lingli'];
   // ← 找不到！因為鍵名是 'lingli_max'
   // 結果：eraRequirement = undefined
   ```

4. **顯示結果（修復前）**
   ```
   所有時期的資源要求都顯示為 "-"（因為都是 undefined）
   ```

---

## ✅ 修復方案

### 修改 CSVLoader.parseCapacity()

```javascript
// 修復前
static parseCapacity(capStr) {
    // ...
    const key = parts[0].trim();  // "lingli_max"
    caps[key] = val;              // {lingli_max: 500}
}

// 修復後
static parseCapacity(capStr) {
    // ...
    let key = parts[0].trim();    // "lingli_max"
    
    // 去除 _max 後綴
    if (key.endsWith('_max')) {
        key = key.replace('_max', '');  // "lingli"
    }
    
    caps[key] = val;              // {lingli: 500}
}
```

### 修復後的數據流程

1. **解析結果**
   ```javascript
   // 練氣期
   {
     lingli: 500  // ← 已去除 _max 後綴
   }
   
   // 金丹期
   {
     lingli: 10000,
     stone: 5000
   }
   ```

2. **查找成功**
   ```javascript
   const eraRequirement = eraCapacityRequirements['lingli'];
   // ✓ 找到了！
   // 練氣期：eraRequirement = 500
   // 金丹期：eraRequirement = 10000
   ```

---

## 🧪 驗證步驟

### 步驟 1: 清除緩存

**非常重要！** 因為修改了 `CSVLoader.js`，必須清除緩存：

1. **Windows / Linux**
   - 按 `Ctrl + Shift + R`

2. **Mac**
   - 按 `Cmd + Shift + R`

3. **或者手動清除**
   - 打開開發者工具（F12）
   - 右鍵點擊刷新按鈕
   - 選擇「清空緩存並硬性重新載入」

---

### 步驟 2: 打開控制台

1. 按 `F12` 打開開發者工具
2. 切換到「Console」標籤
3. 準備查看調試輸出

---

### 步驟 3: 測試練氣期

1. **訪問工具**
   ```
   http://localhost:8000/balance-checker.html
   ```

2. **設置參數**
   - 道心值：0
   - 道證值：0
   - 目標時期：1（練氣期）

3. **點擊「計算資源上限」**

4. **查看控制台輸出**
   ```javascript
   === 資源上限計算器調試 ===
   目標時期: 1
   時期數據: {eraId: 1, eraName: "練氣期", ...}
   容量要求: {lingli: 500}  // ← 應該是 lingli 不是 lingli_max
   解析後的容量要求: {lingli: 500}
   ```

5. **預期結果**
   ```
   資源   | 時期要求
   -------|----------
   靈力   | 500      ← 應該顯示 500
   金錢   | -
   靈木   | -
   靈石   | -
   藥草   | -
   技能點 | -
   ```

---

### 步驟 4: 測試金丹期

1. **設置參數**
   - 道心值：0
   - 道證值：0
   - 目標時期：3（金丹期）

2. **點擊「計算資源上限」**

3. **查看控制台輸出**
   ```javascript
   === 資源上限計算器調試 ===
   目標時期: 3
   時期數據: {eraId: 3, eraName: "金丹期", ...}
   容量要求: {lingli: 10000, stone: 5000}  // ← 注意鍵名
   解析後的容量要求: {lingli: 10000, stone: 5000}
   ```

4. **預期結果**
   ```
   資源   | 時期要求
   -------|----------
   靈力   | 10,000   ← 應該顯示 10,000
   金錢   | -
   靈木   | -
   靈石   | 5,000    ← 應該顯示 5,000
   藥草   | -
   技能點 | -
   ```

---

### 步驟 5: 對比驗證

**確認不同時期顯示不同的要求：**

| 時期 | 靈力要求 | 靈石要求 | 金錢要求 |
|------|----------|----------|----------|
| 1    | 500      | -        | -        |
| 2    | 2,000    | 1,000    | -        |
| 3    | 10,000   | 5,000    | -        |
| 4    | 50,000   | 20,000   | 10,000   |

---

## 🔧 故障排除

### 問題 1: 仍然顯示相同內容

**可能原因**：瀏覽器緩存未清除

**解決方案**：
1. 完全關閉瀏覽器
2. 重新打開瀏覽器
3. 訪問頁面
4. 按 `Ctrl+Shift+R` 強制刷新

---

### 問題 2: 控制台顯示 lingli_max

**症狀**：
```javascript
容量要求: {lingli_max: 500}  // ← 錯誤！應該是 lingli
```

**原因**：CSVLoader.js 的修改未生效

**解決方案**：
1. 檢查 `src/utils/CSVLoader.js` 文件
2. 確認第 273-276 行包含：
   ```javascript
   if (key.endsWith('_max')) {
       key = key.replace('_max', '');
   }
   ```
3. 保存文件
4. 強制刷新頁面

---

### 問題 3: 控制台沒有調試輸出

**原因**：balance-checker.html 的修改未生效

**解決方案**：
1. 檢查 `balance-checker.html` 文件
2. 確認包含調試輸出代碼：
   ```javascript
   console.log('=== 資源上限計算器調試 ===');
   console.log('目標時期:', targetEra);
   console.log('時期數據:', era);
   console.log('容量要求:', era?.upgradeRequirements?.capacity);
   ```
3. 保存文件
4. 強制刷新頁面

---

## 📊 完整測試數據

### 所有時期的資源要求

```
時期1（練氣期）：
  靈力: 500

時期2（築基期）：
  靈力: 2,000
  靈石: 1,000

時期3（金丹期）：
  靈力: 10,000
  靈石: 5,000

時期4（元嬰期）：
  靈力: 50,000
  靈石: 20,000
  金錢: 10,000

時期5（化神期）：
  靈力: 200,000
  靈石: 100,000

時期6（煉虛期）：
  靈力: 1,000,000

時期7（合體期）：
  靈力: 5,000,000

時期8（大乘期）：
  靈力: 20,000,000

時期9（渡劫期）：
  靈力: 100,000,000

時期10（地仙）：
  靈力: 500,000,000

時期11（天仙）：
  靈力: 2,000,000,000

時期12（金仙）：
  靈力: 10,000,000,000
```

---

## ✅ 驗證清單

完成以下檢查確認修復成功：

- [ ] 已強制刷新頁面（Ctrl+Shift+R）
- [ ] 已打開控制台（F12）
- [ ] 控制台顯示調試輸出
- [ ] 控制台中的鍵名是 `lingli` 而不是 `lingli_max`
- [ ] 練氣期顯示靈力要求 500
- [ ] 金丹期顯示靈力要求 10,000
- [ ] 金丹期顯示靈石要求 5,000
- [ ] 不同時期顯示不同的要求
- [ ] 達標判斷正常工作（綠色✓或紅色✗）

---

## 🎯 預期控制台輸出示例

### 練氣期（時期1）
```
=== 資源上限計算器調試 ===
目標時期: 1
時期數據: {
  eraId: 1,
  eraName: "練氣期",
  upgradeRequirements: {
    capacity: {lingli: 500}
  },
  ...
}
容量要求: {lingli: 500}
解析後的容量要求: {lingli: 500}
```

### 金丹期（時期3）
```
=== 資源上限計算器調試 ===
目標時期: 3
時期數據: {
  eraId: 3,
  eraName: "金丹期",
  upgradeRequirements: {
    capacity: {lingli: 10000, stone: 5000}
  },
  ...
}
容量要求: {lingli: 10000, stone: 5000}
解析後的容量要求: {lingli: 10000, stone: 5000}
```

---

## 📝 總結

**修復內容**：
- ✅ 修改 CSVLoader.parseCapacity() 去除 _max 後綴
- ✅ 添加控制台調試輸出
- ✅ 添加緩存清除提示

**關鍵點**：
- 必須強制刷新頁面清除緩存
- 檢查控制台確認鍵名正確
- 不同時期應顯示不同的資源要求

修復完成後，資源上限計算器將正確顯示每個時期的獨特要求！🎉
